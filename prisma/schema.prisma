generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation("AccountToUser", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model CategoryResult {
  id         String       @id
  name       String
  status     String       @default("pending")
  notes      String?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime
  checkId    String
  InfraCheck InfraCheck   @relation(fields: [checkId], references: [id], onDelete: Cascade)
  ItemResult ItemResult[]
}

model CheckComment {
  id         String     @id
  content    String
  createdAt  DateTime   @default(now())
  updatedAt  DateTime
  checkId    String
  authorId   String
  User       User       @relation(fields: [authorId], references: [id])
  InfraCheck InfraCheck @relation(fields: [checkId], references: [id], onDelete: Cascade)
}

model CheckTemplate {
  id               String             @id
  name             String
  description      String?
  isDefault        Boolean            @default(false)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  Client           Client[]
  InfraCheck       InfraCheck[]
  TemplateCategory TemplateCategory[]
}

model Client {
  id                                    String                     @id
  name                                  String
  status                                ClientStatus               @default(ACTIVE)
  slackChannelId                        String?
  slackChannelName                      String?
  notionPageId                          String?
  defaultCadence                        CheckCadence               @default(MONTHLY)
  harvestProjectId                      String?
  notes                                 String?
  createdAt                             DateTime                   @default(now())
  updatedAt                             DateTime
  templateId                            String?
  acceptedPasswordPolicy                String?
  accessRequests                        String?
  checkCadence                          CheckCadence?
  customCadenceDays                     Int?
  dmarc                                 String?
  estimation                            Float?
  hoursPerMonth                         String?
  hrProcesses                           String[]
  itGlueUrl                             String?
  itSyncsFrequency                      String?
  notionLastSynced                      DateTime?
  officeAddress                         String?
  onePasswordUrl                        String?
  onsitesFrequency                      String?
  pocEmail                              String?
  policies                              String[]
  primaryEngineerId                     String?
  priority                              Priority?
  secondaryEngineerId                   String?
  sharedDriveUrl                        String?
  startDate                             DateTime?
  teams                                 String[]
  trelloUrl                             String?
  userAccessReviews                     String?
  websiteUrl                            String?
  zendeskUrl                            String?
  systemEngineerName                    String?
  primaryConsultantName                 String?
  secondaryConsultantNames              String[]
  itManagerName                         String?
  grceEngineerName                      String?
  dmarcRecord                           String?
  dmarcLastChecked                      DateTime?
  infraCheckAssigneeName                String?
  dkim                                  String?
  dkimLastChecked                       DateTime?
  dkimRecord                            String?
  dkimSelector                          String?
  spf                                   String?
  spfLastChecked                        DateTime?
  spfRecord                             String?
  sslExpiry                             DateTime?
  sslIssuer                             String?
  sslLastChecked                        DateTime?
  sslStatus                             String?
  complianceFrameworks                  String[]
  trustCenterPlatform                   String?
  trustCenterUrl                        String?
  grceEngineerId                        String?
  systemEngineerId                      String?
  itManagerId                           String?
  customUrls                            Json?
  User_Client_grceEngineerIdToUser      User?                      @relation("Client_grceEngineerIdToUser", fields: [grceEngineerId], references: [id])
  User_Client_itManagerIdToUser         User?                      @relation("Client_itManagerIdToUser", fields: [itManagerId], references: [id])
  User_Client_primaryEngineerIdToUser   User?                      @relation("Client_primaryEngineerIdToUser", fields: [primaryEngineerId], references: [id])
  User_Client_secondaryEngineerIdToUser User?                      @relation("Client_secondaryEngineerIdToUser", fields: [secondaryEngineerId], references: [id])
  User_Client_systemEngineerIdToUser    User?                      @relation("Client_systemEngineerIdToUser", fields: [systemEngineerId], references: [id])
  CheckTemplate                         CheckTemplate?             @relation(fields: [templateId], references: [id])
  ClientEngineerAssignment              ClientEngineerAssignment[]
  ClientSystem                          ClientSystem[]
  ClientTeam                            ClientTeam[]
  InfraCheck                            InfraCheck[]
  ComplianceAudit                        ComplianceAudit[]
  AccessReview                          AccessReview[]

  @@index([grceEngineerId])
  @@index([itManagerId])
  @@index([primaryEngineerId])
  @@index([secondaryEngineerId])
  @@index([status])
  @@index([systemEngineerId])
}

model ClientEngineerAssignment {
  id        String             @id
  clientId  String
  userId    String
  role      ClientEngineerRole
  createdAt DateTime           @default(now())
  updatedAt DateTime
  Client    Client             @relation(fields: [clientId], references: [id], onDelete: Cascade)
  User      User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([clientId, userId, role])
  @@index([clientId])
  @@index([userId])
}

model ClientSystem {
  id        String   @id
  notes     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime
  clientId  String
  systemId  String
  Client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  System    System   @relation(fields: [systemId], references: [id], onDelete: Cascade)

  @@unique([clientId, systemId])
  @@index([clientId])
  @@index([systemId])
}

model ClientTeam {
  id        String   @id
  clientId  String
  teamId    String
  createdAt DateTime @default(now())
  Client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  Team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([clientId, teamId])
  @@index([clientId])
  @@index([teamId])
}

model Framework {
  id          String            @id
  name        String            @unique
  category    FrameworkCategory
  description String?
  isActive    Boolean           @default(true)
  order       Int               @default(0)
  source      SystemSource      @default(APP)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime
  AuditTypes  AuditType[]
}

model AuditType {
  id          String   @id @default(cuid())
  frameworkId String
  name        String   // e.g., "Type I", "Type II", "Surveillance"
  description String?
  isActive    Boolean  @default(true)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  Framework   Framework @relation(fields: [frameworkId], references: [id], onDelete: Cascade)
  
  @@unique([frameworkId, name])
  @@index([frameworkId])
  @@index([isActive])
}

model RoleConfiguration {
  id            String             @id @default(cuid())
  roleKey       String             @unique // e.g., "SE", "PRIMARY", "JR_SYSTEM_ENGINEER"
  label         String             // e.g., "System Engineer", "Jr System Engineer"
  abbreviation  String             // e.g., "SE", "Jr SE"
  bgColor       String             // e.g., "bg-brand-500/20"
  textColor     String             // e.g., "text-brand-400"
  borderColor   String             // e.g., "border-brand-500/30"
  priority      Int                @default(99) // Lower = higher priority
  allowMultiple Boolean            @default(true)
  maxAssignments Int               @default(0) // 0 = unlimited
  isActive      Boolean            @default(true)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  @@index([roleKey])
  @@index([priority])
}

model InfraCheck {
  id                                       String           @id
  status                                   CheckStatus      @default(SCHEDULED)
  scheduledDate                            DateTime
  startedAt                                DateTime?
  completedAt                              DateTime?
  dueDate                                  DateTime?
  cadence                                  CheckCadence
  calendarEventId                          String?
  slackMessageTs                           String?
  totalTimeSeconds                         Int              @default(0)
  notes                                    String?
  createdAt                                DateTime         @default(now())
  updatedAt                                DateTime
  clientId                                 String
  assignedEngineerId                       String?
  completedById                            String?
  templateId                               String?
  assignedEngineerName                     String?
  calendarEventLink                        String?
  CategoryResult                           CategoryResult[]
  CheckComment                             CheckComment[]
  User_InfraCheck_assignedEngineerIdToUser User?            @relation("InfraCheck_assignedEngineerIdToUser", fields: [assignedEngineerId], references: [id])
  Client                                   Client           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  User_InfraCheck_completedByIdToUser      User?            @relation("InfraCheck_completedByIdToUser", fields: [completedById], references: [id])
  CheckTemplate                            CheckTemplate?   @relation(fields: [templateId], references: [id])
  TimerSession                             TimerSession[]

  @@index([assignedEngineerId])
  @@index([clientId])
  @@index([scheduledDate])
  @@index([status])
}

model IntegrationSettings {
  id           String    @id
  provider     String    @unique
  enabled      Boolean   @default(false)
  apiKey       String?
  apiSecret    String?
  accessToken  String?
  refreshToken String?
  config       String?
  connectedAt  DateTime?
  lastTestedAt DateTime?
  notes        String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime
}

model ItemResult {
  id               String         @id
  text             String
  checked          Boolean        @default(false)
  notes            String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime
  categoryResultId String
  order            Int            @default(0)
  CategoryResult   CategoryResult @relation(fields: [categoryResultId], references: [id], onDelete: Cascade)
}

model LoginActivity {
  id        String   @id
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  userId    String
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([userId])
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation("SessionToUser", fields: [userId], references: [id], onDelete: Cascade)
}

model System {
  id              String             @id
  name            String             @unique
  category        SystemCategoryType
  icon            String?
  description     String?
  isActive        Boolean            @default(true)
  order           Int                @default(0)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime
  source          SystemSource       @default(APP)
  ClientSystem    ClientSystem[]
  SystemCheckItem SystemCheckItem[]
}

model SystemCheckItem {
  id          String   @id
  text        String
  description String?
  order       Int      @default(0)
  isOptional  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  systemId    String
  System      System   @relation(fields: [systemId], references: [id], onDelete: Cascade)
}

model Team {
  id          String       @id
  name        String       @unique
  description String?
  color       String?
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime
  tag         String?
  managerId   String?
  ClientTeam  ClientTeam[]
  User        User?        @relation(fields: [managerId], references: [id])
  UserTeam    UserTeam[]

  @@index([isActive])
  @@index([managerId])
}

model TemplateCategory {
  id            String         @id
  name          String
  icon          String?
  order         Int            @default(0)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime
  templateId    String
  CheckTemplate CheckTemplate  @relation(fields: [templateId], references: [id], onDelete: Cascade)
  TemplateItem  TemplateItem[]
}

model TemplateItem {
  id               String           @id
  text             String
  description      String?
  order            Int              @default(0)
  isOptional       Boolean          @default(false)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime
  categoryId       String
  TemplateCategory TemplateCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
}

model TimerSession {
  id             String     @id
  startTime      DateTime
  endTime        DateTime?
  durationSecs   Int?
  harvestEntryId String?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime
  checkId        String
  userId         String
  InfraCheck     InfraCheck @relation(fields: [checkId], references: [id], onDelete: Cascade)
  User           User       @relation(fields: [userId], references: [id])
}

model ComplianceAudit {
  id              String   @id @default(cuid())
  clientId        String
  framework       String   // "SOC2", "ISO27001", "HIPAA"
  auditType       String   // "Type I", "Type II", "Surveillance", "Recertification", "Risk Assessment"
  lastAuditDate   DateTime // When last audit was completed
  auditPeriod     Int      // Period in months (12 for annual, 36 for 3-year)
  nextAuditDue    DateTime // Calculated: lastAuditDate + auditPeriod, but editable
  actualDate      DateTime? // When audit actually happened (may differ from scheduled)
  status          String   // "SCHEDULED", "IN_PROGRESS", "COMPLETED", "OVERDUE"
  auditor         String?  // Auditor name/company
  evidenceUrl     String?  // Link to audit report
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdById     String?  // Who created this audit period
  updatedById     String?  // Who last updated
  
  Client          Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  CreatedBy       User?    @relation("CreatedAudits", fields: [createdById], references: [id])
  UpdatedBy       User?    @relation("UpdatedAudits", fields: [updatedById], references: [id])
  
  @@index([clientId])
  @@index([framework])
  @@index([status])
  @@index([nextAuditDue])
}

model AccessReview {
  id              String   @id @default(cuid())
  clientId        String
  framework       String?  // "SOC2", "ISO27001", "HIPAA", or null for general
  reviewDate      DateTime // When review is scheduled/due
  dueDate         DateTime
  cadence         String   // "QUARTERLY", "SEMI_ANNUAL", "ANNUAL", "CUSTOM"
  customDays      Int?     // For custom cadence
  status          String   // "SCHEDULED", "IN_PROGRESS", "COMPLETED", "OVERDUE"
  assignedToId    String?  // User ID (typically GRC Engineer)
  completedById   String?  // User ID (who actually completed it)
  completedAt     DateTime? // When it was completed
  evidenceUrl     String?  // Link to review report/documentation
  notes           String?
  totalTimeSeconds Int     @default(0) // Time spent on review
  autoSchedule    Boolean  @default(true) // Whether to auto-schedule next
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  Client          Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  AssignedTo      User?    @relation("AssignedAccessReviews", fields: [assignedToId], references: [id])
  CompletedBy     User?    @relation("CompletedAccessReviews", fields: [completedById], references: [id])
  
  // Audit trail
  AuditLog        AccessReviewAuditLog[]
  TimerSession    AccessReviewTimerSession[]
  
  @@index([clientId])
  @@index([reviewDate])
  @@index([status])
  @@index([assignedToId])
  @@index([framework])
  @@index([completedAt])
}

// Audit trail for access reviews
model AccessReviewAuditLog {
  id              String   @id @default(cuid())
  reviewId        String
  action          String   // "CREATED", "UPDATED", "COMPLETED", "EVIDENCE_ADDED", "NOTES_UPDATED"
  field           String?  // Which field was changed
  oldValue        String?  // Previous value
  newValue        String?  // New value
  userId          String   // Who made the change
  timestamp       DateTime @default(now())
  notes           String?  // Additional context
  
  Review          AccessReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  User            User         @relation(fields: [userId], references: [id])
  
  @@index([reviewId])
  @@index([userId])
  @@index([timestamp])
}

// Time tracking for access reviews
model AccessReviewTimerSession {
  id              String   @id @default(cuid())
  reviewId        String
  userId          String
  startTime       DateTime
  endTime         DateTime?
  durationSeconds Int?     // Calculated duration
  notes           String?
  
  Review          AccessReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  User            User         @relation(fields: [userId], references: [id])
  
  @@index([reviewId])
  @@index([userId])
}

model User {
  id                                             String                     @id
  name                                           String?
  email                                          String?                    @unique
  emailVerified                                  DateTime?
  image                                          String?
  role                                           UserRole                   @default(VIEWER)
  createdAt                                      DateTime                   @default(now())
  updatedAt                                      DateTime
  notionTeamMemberId                             String?
  notionTeamMemberName                           String?
  harvestAccessToken                             String?
  harvestAccountId                               String?
  harvestUserId                                  String?
  googleCalendarAccessToken                      String?
  googleCalendarRefreshToken                     String?
  googleCalendarExpiresAt                        DateTime?
  slackUsername                                  String?
  slackUserId                                    String?
  notifyOverdueChecks                            Boolean                    @default(true)
  notifySlackReminders                           Boolean                    @default(true)
  notifyWeeklySummary                            Boolean                    @default(false)
  timezone                                       String                     @default("America/Los_Angeles")
  team                                           String?
  jobTitle                                       String?
  managerId                                      String?
  lastLoginAt                                    DateTime?
  loginCount                                     Int                        @default(0)
  accounts                                       Account[]                   @relation("AccountToUser")
  CheckComment                                   CheckComment[]
  Client_Client_grceEngineerIdToUser             Client[]                   @relation("Client_grceEngineerIdToUser")
  Client_Client_itManagerIdToUser                Client[]                   @relation("Client_itManagerIdToUser")
  Client_Client_primaryEngineerIdToUser          Client[]                   @relation("Client_primaryEngineerIdToUser")
  Client_Client_secondaryEngineerIdToUser        Client[]                   @relation("Client_secondaryEngineerIdToUser")
  Client_Client_systemEngineerIdToUser           Client[]                   @relation("Client_systemEngineerIdToUser")
  ClientEngineerAssignment                       ClientEngineerAssignment[]
  InfraCheck_InfraCheck_assignedEngineerIdToUser InfraCheck[]               @relation("InfraCheck_assignedEngineerIdToUser")
  InfraCheck_InfraCheck_completedByIdToUser      InfraCheck[]               @relation("InfraCheck_completedByIdToUser")
  LoginActivity                                  LoginActivity[]
  sessions                                      Session[]                   @relation("SessionToUser")
  Team                                           Team[]
  TimerSession                                   TimerSession[]
  User                                           User?                      @relation("UserToUser", fields: [managerId], references: [id])
  other_User                                     User[]                     @relation("UserToUser")
  UserTeam                                       UserTeam[]
  CreatedAudits                                  ComplianceAudit[]           @relation("CreatedAudits")
  UpdatedAudits                                  ComplianceAudit[]           @relation("UpdatedAudits")
  AssignedAccessReviews                          AccessReview[]             @relation("AssignedAccessReviews")
  CompletedAccessReviews                         AccessReview[]             @relation("CompletedAccessReviews")
  AccessReviewAuditLog                           AccessReviewAuditLog[]
  AccessReviewTimerSession                       AccessReviewTimerSession[]
}

model UserTeam {
  id        String   @id
  userId    String
  teamId    String
  createdAt DateTime @default(now())
  Team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, teamId])
  @@index([teamId])
  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum CheckCadence {
  WEEKLY
  BIWEEKLY
  MONTHLY
  BIMONTHLY
  QUARTERLY
  ADHOC
  CUSTOM
}

enum CheckStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  OVERDUE
}

enum ClientEngineerRole {
  SE
  GRCE
  PRIMARY
  SECONDARY
  IT_MANAGER
}

enum ClientStatus {
  ACTIVE
  INACTIVE
  ONBOARDING
  OFFBOARDING
  ON_HOLD
  EXITING
  AS_NEEDED
}

enum FrameworkCategory {
  SECURITY
  PRIVACY
  GOVERNMENT
  INDUSTRY
  OTHER
}

enum Priority {
  P1
  P2
  P3
  P4
}

enum SystemCategoryType {
  IDENTITY
  MDM
  AV_EDR
  PASSWORD
  GRC
  SECURITY_TRAINING
  BACKUP
  EMAIL_SECURITY
  OTHER
}

enum SystemSource {
  APP
  NOTION
  SEEDED
}

enum UserRole {
  ADMIN
  IT_MANAGER
  IT_ENGINEER
  CONSULTANT
  VIEWER
}
